<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修仙数值游戏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-image: url('https://cdn.pixabay.com/photo/2016/05/24/16/48/mountains-1412683_1280.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #333;
            line-height: 1.6;
        }
        
        #game-container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            padding: 20px;
            position: relative;
            min-height: 90vh;
        }
        
        header {
            text-align: center;
            padding: 10px 0 20px;
            border-bottom: 2px solid #A67C52;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #8B4513;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            font-size: 2em;
        }
        
        #game-content {
            display: flex;
            flex-direction: column;
            min-height: 70vh;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #5D4037;
        }
        
        .input-group input {
            width: 300px;
            padding: 10px;
            border: 1px solid #A67C52;
            border-radius: 5px;
            font-size: 16px;
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #8B4513;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background-color: #5D4037;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        #main-screen {
            display: none;
            flex-direction: column;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: rgba(165, 42, 42, 0.1);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .sect-info, .player-info {
            flex: 1;
            padding: 10px;
            font-size: 0.8em;
        }
        
        .sect-info h3, .player-info h3 {
            color: #8B4513;
            margin-bottom: 5px;
        }
        
        .game-stats {
            display: flex;
            flex-wrap: wrap;
            background-color: rgba(222, 184, 135, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            flex: 1;
            min-width: 150px;
            padding: 8px;
            text-align: center;
        }
        
        .stat-label {
            font-weight: bold;
            color: #5D4037;
        }
        
        .game-main {
            display: flex;
            flex-grow: 1;
        }
        
        .left-panel, .right-panel {
            flex: 1;
            padding: 15px;
        }
        
        .center-panel {
            flex: 2;
            padding: 15px;
            position: relative;
        }
        
        .panel-title {
            background-color: #8B4513;
            color: white;
            padding: 8px 15px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 10px;
        }
        
        .panel-content {
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid #A67C52;
            border-radius: 0 0 8px 8px;
            padding: 15px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* 徒弟列表样式 */
        .disciple-list {
            list-style: none;
        }
        
        .disciple-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 3px;
            border: 1px solid #A67C52;
            background-color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        
        .disciple-item:hover {
            background-color: rgba(222, 184, 135, 0.3);
            transform: translateX(5px);
        }
        
        .disciple-item.selected {
            background-color: rgba(165, 42, 42, 0.1);
            border-left: 4px solid #8B4513;
        }
        
        /* 徒弟详情样式 */
        .disciple-detail {
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border: 1px solid #A67C52;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #A67C52;
        }
        
        .attribute-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .attribute-item {
            padding: 5px;
            background-color: rgba(222, 184, 135, 0.2);
            border-radius: 4px;
        }
        
        .attribute-label {
            font-weight: bold;
            color: #5D4037;
        }
        
        /* 丹药传递可视化 */
        .transfer-container {
            position: relative;
            height: 200px;
            margin: 20px 0;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            border: 1px dashed #A67C52;
        }
        
        .transfer-line {
            position: absolute;
            top: 50%;
            left: 10%;
            width: 80%;
            height: 4px;
            background-color: #A67C52;
            transform: translateY(-50%);
        }
        
        .transfer-pill {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #ff5722;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transition: left 1s linear;
        }
        
        .transfer-direction {
            position: absolute;
            top: 70%;
            width: 100%;
            text-align: center;
            font-weight: bold;
            color: #5D4037;
        }
        
        /* 控制面板 */
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* 进度条样式 */
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #8B4513;
            border-radius: 10px;
            transition: width 0.3s;
        }
        
        /* 对话框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #5D4037;
        }
        
        /* 五行属性颜色 */
        .element-gold {
            color: #FFD700;
        }
        
        .element-wood {
            color: #228B22;
        }
        
        .element-water {
            color: #1E90FF;
        }
        
        .element-fire {
            color: #FF4500;
        }
        
        .element-earth {
            color: #8B4513;
        }
        
        /* 修真境界样式 */
        .cultivation-stage {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: rgba(139, 69, 19, 0.1);
        }
        
        /* 顶部导航 */
        .game-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
            background-color: rgba(139, 69, 19, 0.2);
            border-radius: 5px;
            padding: 5px;
        }
        
        .nav-item {
            padding: 5px 10px;
            margin: 0 3px;
            background-color: rgba(139, 69, 19, 0.7);
            color: white;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .nav-item:hover {
            background-color: #8B4513;
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            background-color: #5D4037;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* 战斗界面 */
        #battle-screen {
            display: none;
            flex-direction: column;
        }
        
        .battle-arena {
            display: flex;
            justify-content: space-between;
            min-height: 400px;
            background-image: url('https://cdn.pixabay.com/photo/2018/08/14/13/23/mountain-3605527_1280.jpg');
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .battle-side {
            width: 45%;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            padding: 15px;
        }
        
        .battle-logs {
            height: 200px;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .battle-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .log-entry {
            padding: 5px;
            margin-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .log-damage {
            color: #ff4500;
            font-weight: bold;
        }
        
        .log-heal {
            color: #228B22;
            font-weight: bold;
        }
        
        .battle-character {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .character-avatar {
            width: 100px;
            height: 100px;
            background-color: #e0e0e0;
            border-radius: 50%;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #5D4037;
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .slide-in {
            animation: slideInRight 0.5s ease-out;
        }
        
        /* 数值变化动画 */
        @keyframes numberChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); color: #ff5722; }
            100% { transform: scale(1); }
        }
        
        .number-change {
            animation: numberChange 0.5s ease-out;
        }
        
        /* 浮动数字效果 */
        .floating-number {
            position: absolute;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            animation: floatUp 1.5s ease-out forwards;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        /* 其他宗门列表 */
        .other-sects {
            margin-top: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            border: 1px solid #A67C52;
        }
        
        .sect-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sect-item:hover {
            background-color: rgba(222, 184, 135, 0.3);
        }
        
        .sect-relation {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .relation-hostile {
            background-color: rgba(255, 0, 0, 0.2);
            color: #d32f2f;
        }
        
        .relation-neutral {
            background-color: rgba(255, 152, 0, 0.2);
            color: #f57c00;
        }
        
        .relation-friendly {
            background-color: rgba(76, 175, 80, 0.2);
            color: #388e3c;
        }
        
        .relation-allied {
            background-color: rgba(33, 150, 243, 0.2);
            color: #1976d2;
        }
        
        /* 游戏目标进度 */
        .game-goal {
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(33, 150, 243, 0.1);
            border-radius: 8px;
            border: 1px solid #1976d2;
        }
        
        .goal-title {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 5px;
        }
        
        /* 战斗效果 */
        .attack-effect {
            position: absolute;
            width: 50px;
            height: 50px;
            background-image: url('https://cdn.pixabay.com/photo/2013/07/13/10/23/explosion-157465_1280.png');
            background-size: contain;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 10;
            animation: explode 0.5s ease-out forwards;
        }
        
        @keyframes explode {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .health-change {
            animation: healthChange 0.5s ease-out;
        }
        
        @keyframes healthChange {
            0% { background-color: #ff5722; }
            100% { background-color: #4CAF50; }
        }
        
        /* 统一视图样式 */
        .unified-view {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .info-card {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 250px;
        }
        
        .info-card-header {
            border-bottom: 1px solid #A67C52;
            padding-bottom: 5px;
            margin-bottom: 8px;
            font-weight: bold;
            color: #8B4513;
        }
        
        /* 其他宗门信息样式 */
        .other-sect-info {
            margin-top: 10px;
            padding: 8px;
            background-color: rgba(222, 184, 135, 0.2);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .other-sect-info:hover {
            background-color: rgba(222, 184, 135, 0.4);
        }
        
        /* 紧凑的信息显示 */
        .compact-info {
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .compact-info .label {
            color: #5D4037;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <header>
            <h1>修仙数值游戏</h1>
        </header>
        
        <div id="game-content">
            <!-- 开始界面 -->
            <div id="start-screen">
                <h2>踏入仙途，缘定三生</h2>
                <div class="input-group">
                    <label for="sect-name">为宗门命名</label>
                    <input type="text" id="sect-name" placeholder="请输入宗门名称" maxlength="20">
                </div>
                <div class="input-group">
                    <label for="player-name">为自己取道号</label>
                    <input type="text" id="player-name" placeholder="请输入道号" maxlength="20">
                </div>
                <button id="start-game" class="btn">开启修仙之路</button>
            </div>
            
            <!-- 主游戏界面 -->
            <div id="main-screen">
                <div class="game-header">
                    <div class="sect-info">
                        <h3>宗门：<span id="display-sect-name">未命名</span> <span id="sect-level">1</span>级</h3>
                    </div>
                    <div class="player-info">
                        <h3>掌门：<span id="display-player-name">未命名</span> <span id="player-stage" class="cultivation-stage">炼气期</span></h3>
                    </div>
                </div>
                
                <div class="game-stats">
                    <div class="stat-item">
                        <div class="stat-label">灵石</div>
                        <div id="resource-spirit-stone">100</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">丹药数量</div>
                        <div id="resource-pills">10</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">弟子数量</div>
                        <div><span id="disciple-count">0</span>/<span id="disciple-max">5</span></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">宗门威望</div>
                        <div id="sect-prestige">50</div>
                    </div>
                </div>
                
                <div class="game-main">
                    <div class="left-panel">
                        <div class="panel-title">弟子列表</div>
                        <div class="panel-content">
                            <ul id="disciple-list" class="disciple-list">
                                <li class="no-disciples">暂无弟子，请招收弟子</li>
                            </ul>
                            <div class="control-panel">
                                <button id="recruit-disciple" class="btn">招收弟子</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="center-panel">
                        <div class="panel-title">弟子详情</div>
                        <div class="panel-content">
                            <div id="disciple-detail" class="disciple-detail" style="display: none;">
                                <div class="detail-header">
                                    <h3 id="detail-name">弟子姓名</h3>
                                    <div id="detail-cultivation" class="cultivation-stage">炼气初期</div>
                                </div>
                                
                                <div class="attribute-list">
                                    <div class="attribute-item">
                                        <span class="attribute-label">灵根：</span>
                                        <span id="detail-element">未知</span>
                                    </div>
                                    <div class="attribute-item">
                                        <span class="attribute-label">纯度：</span>
                                        <span id="detail-purity">0%</span>
                                    </div>
                                    <div class="attribute-item">
                                        <span class="attribute-label">悟性：</span>
                                        <span id="detail-comprehension">0</span>
                                    </div>
                                    <div class="attribute-item">
                                        <span class="attribute-label">气运：</span>
                                        <span id="detail-luck">0</span>
                                    </div>
                                </div>
                                
                                <div class="progress-container" style="margin-top: 15px;">
                                    <div>修炼进度：<span id="cultivation-progress-text">0</span>%</div>
                                    <div class="progress-bar">
                                        <div id="cultivation-progress" class="progress-fill" style="width: 0%;"></div>
                                    </div>
                                </div>
                                
                                <div class="control-panel">
                                    <button id="give-pill" class="btn">赐予丹药</button>
                                    <button id="collect-pill" class="btn" disabled>收集丹药</button>
                                    <button id="breakthrough" class="btn" disabled>尝试突破</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="right-panel">
                        <div class="panel-title">宗门事务</div>
                        <div class="panel-content">
                            <div id="events-log" style="height: 300px; overflow-y: auto;">
                                <div class="log-entry">宗门创立，万载传承由此开始！</div>
                            </div>
                            <div class="control-panel">
                                <button id="sect-upgrade" class="btn">宗门升级</button>
                                <button id="open-battle" class="btn">宗门对战</button>
                            </div>
                            
                            <!-- 游戏目标进度 -->
                            <div class="game-goal">
                                <div class="goal-title">终极目标：飞升成仙</div>
                                <div>需达成：</div>
                                <ul>
                                    <li>宗门等级达到10级 (<span id="goal-sect-level">1</span>/10)</li>
                                    <li>掌门修为达到化神期 (<span id="goal-player-stage">炼气期</span>/化神期)</li>
                                    <li>拥有5名金丹期以上弟子 (<span id="goal-disciples">0</span>/5)</li>
                                    <li>宗门威望达到1000 (<span id="goal-prestige">50</span>/1000)</li>
                                </ul>
                                <div class="progress-bar" style="margin-top: 10px;">
                                    <div id="goal-progress" class="progress-fill" style="width: 0%; background-color: #1976d2;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 其他宗门列表 -->
                <div class="other-sects" id="other-sects">
                    <h3>仙门志</h3>
                    <div id="sect-list">
                        <!-- 其他宗门会显示在这里 -->
                    </div>
                </div>
                
                <!-- 游戏提示 -->
                <div id="game-tips" style="margin-top: 15px; padding: 10px; background-color: rgba(255, 255, 255, 0.7); border-radius: 8px; text-align: center;">
                    <p>提示：招收弟子并赐予丹药可以加速修炼，提升宗门实力。</p>
                </div>
            </div>
            
            <!-- 战斗界面 -->
            <div id="battle-screen">
                <div class="battle-arena">
                    <div class="battle-side" id="player-side">
                        <div class="battle-character">
                            <div class="character-avatar" id="player-avatar">我</div>
                            <div id="player-battle-name">玩家</div>
                            <div class="progress-bar">
                                <div id="player-health" class="progress-fill" style="width: 100%; background-color: #4CAF50;"></div>
                            </div>
                            <div>灵力：<span id="player-mana">100</span>/100</div>
                            <div>生命：<span id="player-hp">1000</span>/1000</div>
                        </div>
                        <div id="player-disciples">
                            <!-- 玩家弟子会显示在这里 -->
                        </div>
                    </div>
                    
                    <div class="battle-side" id="enemy-side">
                        <div class="battle-character">
                            <div class="character-avatar" id="enemy-avatar">敌</div>
                            <div id="enemy-battle-name">敌对宗门</div>
                            <div class="progress-bar">
                                <div id="enemy-health" class="progress-fill" style="width: 100%; background-color: #4CAF50;"></div>
                            </div>
                            <div>灵力：<span id="enemy-mana">100</span>/100</div>
                            <div>生命：<span id="enemy-hp">1000</span>/1000</div>
                        </div>
                        <div id="enemy-disciples">
                            <!-- 敌方弟子会显示在这里 -->
                        </div>
                    </div>
                </div>
                
                <div class="battle-logs" id="battle-logs">
                    <div class="log-entry">战斗开始！</div>
                </div>
                
                <div class="battle-controls">
                    <button id="attack-btn" class="btn">普通攻击</button>
                    <button id="skill-btn" class="btn">使用技能</button>
                    <button id="formation-btn" class="btn">启动阵法</button>
                    <button id="end-battle" class="btn">结束战斗</button>
                </div>
            </div>
        </div>
        
        <!-- 对话框 -->
        <div id="recruit-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h3>招收弟子</h3>
                <p>灵石消耗：50</p>
                <div id="candidate-disciple" style="margin: 15px 0; padding: 10px; border: 1px solid #A67C52; border-radius: 5px;">
                    <!-- 弟子信息将在这里显示 -->
                </div>
                <div class="control-panel">
                    <button id="accept-disciple" class="btn">收为弟子</button>
                    <button id="reject-disciple" class="btn">重新寻找</button>
                </div>
            </div>
        </div>
        
        <div id="breakthrough-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h3>突破境界</h3>
                <p>弟子<span id="breakthrough-name">某某</span>正在尝试突破...</p>
                <div class="progress-bar">
                    <div id="breakthrough-progress" class="progress-fill" style="width: 0%;"></div>
                </div>
                <p id="breakthrough-result" style="margin-top: 15px;"></p>
                <button id="close-breakthrough" class="btn" style="margin-top: 15px; display: none;">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 游戏核心数据
        const gameData = {
            player: {
                name: "",
                sect: "",
                stage: 0, // 0: 炼气, 1: 筑基, 2: 金丹, 3: 元婴, 4: 化神
                stageNames: ["炼气期", "筑基期", "金丹期", "元婴期", "化神期"],
                subStageNames: ["初期", "中期", "后期", "圆满"],
                subStage: 0,
                resources: {
                    spiritStones: 100,
                    pills: 10
                }
            },
            sect: {
                level: 1,
                prestige: 50,
                maxDisciples: 5
            },
            disciples: [],
            events: [],
            battleMode: false,
            currentDisciple: null
        };
        
        // 五行属性数据
        const elements = {
            gold: { name: "金", color: "#FFD700", weakness: "fire", strength: "wood" },
            wood: { name: "木", color: "#228B22", weakness: "gold", strength: "earth" },
            earth: { name: "土", color: "#8B4513", weakness: "wood", strength: "water" },
            water: { name: "水", color: "#1E90FF", weakness: "earth", strength: "fire" },
            fire: { name: "火", color: "#FF4500", weakness: "water", strength: "gold" }
        };
        
        // 变异属性
        const variations = {
            thunder: { name: "雷", description: "无视30%防御但灵力消耗×2" },
            ice: { name: "冰", description: "攻击附带减速，叠加5层触发冻结" },
            poison: { name: "毒", description: "持续伤害可穿透护盾，但对金属性无效" }
        };
        
        // 天赋列表
        const talents = [
            { id: "sword_talent", name: "剑道奇才", description: "剑诀伤害+200%，但无法使用法宝", condition: "御剑飞行100次未坠落" },
            { id: "pill_poison", name: "丹毒体质", description: "每次服用丹药有5%概率转化为「毒灵根」，可反向毒杀敌人" },
            { id: "dragon_blood", name: "真龙血脉", description: "濒死时有极小概率觉醒，免死并全属性×5", activation: "濒死" },
            { id: "dual_cultivation", name: "双修体质", description: "可同时修炼两种功法，但进度减半", activated: false },
            { id: "reincarnation", name: "九转轮回体", description: "每次突破失败不会受到反噬，还有机会获得感悟", activated: false }
        ];
        
        // 随机姓名生成
        const surnames = ["李", "王", "张", "刘", "陈", "杨", "赵", "黄", "周", "吴", "徐", "孙", "朱", "马", "胡", "林", "郭", "何", "高", "罗", "郑", "梁", "谢", "宋", "唐", "许", "邓", "冯", "韩", "曹", "曾", "彭", "萧", "蒋", "沈", "韦", "任", "姚", "袁", "钟", "杜", "戴", "邹", "江", "董", "范", "梅", "苏", "潘", "龙", "殷", "贾", "夏", "锺", "田", "霍", "姜", "潘"];
        
        const names1 = ["玄", "灵", "幽", "清", "云", "逍", "慕", "剑", "风", "雨", "雪", "月", "星", "夜", "天", "紫", "青", "流", "雷", "电", "霜", "霞", "尘", "沐", "白", "千", "百", "万", "绝", "无", "有", "太", "上", "鸿", "洛", "落", "隐", "仙"];
        
        const names2 = ["尘", "风", "云", "霜", "雨", "雪", "天", "明", "暗", "冥", "焰", "然", "川", "泽", "隐", "逸", "远", "辰", "晨", "阳", "旭", "瑶", "璃", "殇", "羽", "澜", "珠", "宁", "蓝", "灵", "虚", "寒", "霄", "宵", "梦", "蝶", "语", "凡"];
        
        // DOM元素引用
        const DOM = {
            startScreen: document.getElementById("start-screen"),
            mainScreen: document.getElementById("main-screen"),
            battleScreen: document.getElementById("battle-screen"),
            sectNameInput: document.getElementById("sect-name"),
            playerNameInput: document.getElementById("player-name"),
            startGameBtn: document.getElementById("start-game"),
            displaySectName: document.getElementById("display-sect-name"),
            displayPlayerName: document.getElementById("display-player-name"),
            sectLevel: document.getElementById("sect-level"),
            playerStage: document.getElementById("player-stage"),
            resourceSpiritStone: document.getElementById("resource-spirit-stone"),
            resourcePills: document.getElementById("resource-pills"),
            discipleCount: document.getElementById("disciple-count"),
            discipleMax: document.getElementById("disciple-max"),
            sectPrestige: document.getElementById("sect-prestige"),
            discipleList: document.getElementById("disciple-list"),
            recruitDiscipleBtn: document.getElementById("recruit-disciple"),
            recruitModal: document.getElementById("recruit-modal"),
            candidateDisciple: document.getElementById("candidate-disciple"),
            acceptDiscipleBtn: document.getElementById("accept-disciple"),
            rejectDiscipleBtn: document.getElementById("reject-disciple"),
            closeButtons: document.querySelectorAll(".close-button"),
            discipleDetail: document.getElementById("disciple-detail"),
            detailName: document.getElementById("detail-name"),
            detailCultivation: document.getElementById("detail-cultivation"),
            detailElement: document.getElementById("detail-element"),
            detailPurity: document.getElementById("detail-purity"),
            detailComprehension: document.getElementById("detail-comprehension"),
            detailLuck: document.getElementById("detail-luck"),
            cultivationProgress: document.getElementById("cultivation-progress"),
            givePillBtn: document.getElementById("give-pill"),
            collectPillBtn: document.getElementById("collect-pill"),
            breakthroughBtn: document.getElementById("breakthrough"),
            transferPill: document.getElementById("transfer-pill"),
            transferDirection: document.getElementById("transfer-direction"),
            eventsLog: document.getElementById("events-log"),
            sectUpgradeBtn: document.getElementById("sect-upgrade"),
            openBattleBtn: document.getElementById("open-battle"),
            breakthroughModal: document.getElementById("breakthrough-modal"),
            breakthroughName: document.getElementById("breakthrough-name"),
            breakthroughProgress: document.getElementById("breakthrough-progress"),
            breakthroughResult: document.getElementById("breakthrough-result"),
            closeBreakthroughBtn: document.getElementById("close-breakthrough"),
            navItems: document.querySelectorAll(".nav-item"),
            endBattleBtn: document.getElementById("end-battle"),
            battleLogs: document.getElementById("battle-logs"),
            attackBtn: document.getElementById("attack-btn"),
            skillBtn: document.getElementById("skill-btn"),
            formationBtn: document.getElementById("formation-btn")
        };
        
        // 游戏初始化
        function initGame() {
            // 设置事件监听器
            DOM.startGameBtn.addEventListener("click", startGame);
            DOM.recruitDiscipleBtn.addEventListener("click", openRecruitModal);
            DOM.acceptDiscipleBtn.addEventListener("click", acceptDisciple);
            DOM.rejectDiscipleBtn.addEventListener("click", generateCandidateDisciple);
            DOM.closeButtons.forEach(btn => {
                btn.addEventListener("click", function() {
                    this.parentElement.parentElement.style.display = "none";
                });
            });
            DOM.givePillBtn.addEventListener("click", givePill);
            DOM.collectPillBtn.addEventListener("click", collectPill);
            DOM.breakthroughBtn.addEventListener("click", attemptBreakthrough);
            DOM.sectUpgradeBtn.addEventListener("click", upgradeSect);
            DOM.openBattleBtn.addEventListener("click", startBattle);
            DOM.closeBreakthroughBtn.addEventListener("click", closeBreakthroughModal);
            DOM.endBattleBtn.addEventListener("click", endBattle);
            DOM.attackBtn.addEventListener("click", performAttack);
            DOM.skillBtn.addEventListener("click", useSkill);
            DOM.formationBtn.addEventListener("click", activateFormation);
            
            // 导航标签切换
            DOM.navItems.forEach(item => {
                item.addEventListener("click", function() {
                    DOM.navItems.forEach(nav => nav.classList.remove("active"));
                    this.classList.add("active");
                    
                    // 执行标签切换逻辑
                    const tab = this.getAttribute("data-tab");
                    if (tab === "battle") {
                        startBattle();
                    }
                });
            });
            
            // 随机名称提示
            DOM.sectNameInput.placeholder = `请输入宗门名称（如：${getRandomSectName()}）`;
            DOM.playerNameInput.placeholder = `请输入道号（如：${getRandomName()}）`;
        }
        
        // 开始游戏
        function startGame() {
            const sectName = DOM.sectNameInput.value.trim() || getRandomSectName();
            const playerName = DOM.playerNameInput.value.trim() || getRandomName();
            
            gameData.player.name = playerName;
            gameData.player.sect = sectName;
            
            // 更新UI
            DOM.displaySectName.textContent = sectName;
            DOM.displayPlayerName.textContent = playerName;
            DOM.playerStage.textContent = gameData.player.stageNames[gameData.player.stage];
            
            // 切换到主屏幕
            DOM.startScreen.style.display = "none";
            DOM.mainScreen.style.display = "flex";
            
            // 记录创建宗门事件
            logEvent(`${playerName}创建了${sectName}，踏上了漫漫修仙路。`);
            
            // 初始化游戏定时器
            startGameLoop();
        }
        
        // 游戏主循环
        function startGameLoop() {
            setInterval(() => {
                updateDisciples();
                updateResources();
                updateUI();
            }, 1000);
        }
        
        // 更新所有弟子状态
        function updateDisciples() {
            gameData.disciples.forEach(disciple => {
                // 只有非突破状态的弟子才增加修炼进度
                if (!disciple.breaking) {
                    // 基础进度增长
                    const baseProgress = 0.1;
                    
                    // 根据悟性计算修炼速度加成
                    const comprehensionBonus = Math.log(disciple.comprehension) / Math.log(10) * 0.3;
                    
                    // 根据灵根纯度计算修炼速度加成
                    const purityBonus = disciple.purity / 100 * 0.5;
                    
                    // 计算总进度增长
                    let progressGain = baseProgress * (1 + comprehensionBonus + purityBonus);
                    
                    // 如果有丹药加速，增加进度
                    if (disciple.pillEffect > 0) {
                        progressGain *= 3;
                        disciple.pillEffect -= 1;
                    }
                    
                    // 增加修炼进度
                    disciple.cultivation.progress += progressGain;
                    
                    // 检查是否可以突破
                    if (disciple.cultivation.progress >= 100) {
                        disciple.canBreakthrough = true;
                    }
                    
                    // 如果是当前选中的弟子，更新UI
                    if (gameData.currentDisciple && gameData.currentDisciple.id === disciple.id) {
                        updateDiscipleDetail();
                    }
                }
            });
        }
        
        // 更新资源
        function updateResources() {
            // 基础灵石收入
            const baseIncome = gameData.sect.level;
            
            // 根据弟子数量增加收入
            const discipleBonus = gameData.disciples.length * 0.5;
            
            // 计算总收入
            const totalIncome = Math.floor(baseIncome * (1 + discipleBonus) * 0.1);
            
            // 增加灵石
            gameData.player.resources.spiritStones += totalIncome;
            
            // 每10秒生产一颗丹药
            if (Math.random() < 0.1) {
                gameData.player.resources.pills += 1;
            }
        }
        
        // 更新UI
        function updateUI() {
            DOM.resourceSpiritStone.textContent = gameData.player.resources.spiritStones;
            DOM.resourcePills.textContent = gameData.player.resources.pills;
            DOM.discipleCount.textContent = gameData.disciples.length;
            DOM.discipleMax.textContent = gameData.sect.maxDisciples;
            DOM.sectPrestige.textContent = gameData.sect.prestige;
            DOM.sectLevel.textContent = gameData.sect.level;
        }
        
        // 打开招收弟子对话框
        function openRecruitModal() {
            // 检查是否已达到弟子上限
            if (gameData.disciples.length >= gameData.sect.maxDisciples) {
                logEvent(`宗门弟子已达上限，无法继续招收。请提升宗门等级或淘汰弟子。`);
                return;
            }
            
            // 检查灵石是否足够
            if (gameData.player.resources.spiritStones < 50) {
                logEvent(`灵石不足，无法招收弟子。`);
                return;
            }
            
            // 生成候选弟子
            generateCandidateDisciple();
            
            // 显示对话框
            DOM.recruitModal.style.display = "flex";
        }
        
        // 生成候选弟子
        function generateCandidateDisciple() {
            const candidate = generateDisciple();
            
            // 创建弟子信息HTML
            let html = `
                <h4>${candidate.name}</h4>
                <div class="attribute-list" style="margin-top: 10px;">
                    <div class="attribute-item">
                        <span class="attribute-label">灵根：</span>
                        <span class="element-${candidate.element}">${elements[candidate.element].name}</span>
                        ${candidate.variation ? `<span>（变异：${variations[candidate.variation].name}）</span>` : ''}
                    </div>
                    <div class="attribute-item">
                        <span class="attribute-label">纯度：</span>
                        <span>${candidate.purity}%</span>
                    </div>
                    <div class="attribute-item">
                        <span class="attribute-label">悟性：</span>
                        <span>${candidate.comprehension}</span>
                    </div>
                    <div class="attribute-item">
                        <span class="attribute-label">气运：</span>
                        <span>${candidate.luck}</span>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <div><strong>隐藏天赋：</strong>${candidate.talent ? candidate.talent.name : '无'}</div>
                    <div><strong>因果链：</strong>${candidate.fate ? candidate.fate : '无'}</div>
                </div>
            `;
            
            DOM.candidateDisciple.innerHTML = html;
            
            // 保存候选弟子数据
            gameData.candidateDisciple = candidate;
        }
        
        // 接受弟子
        function acceptDisciple() {
            // 扣除灵石
            gameData.player.resources.spiritStones -= 50;
            
            // 添加弟子到列表
            const disciple = gameData.candidateDisciple;
            disciple.id = generateId();
            gameData.disciples.push(disciple);
            
            // 更新弟子列表UI
            updateDiscipleList();
            
            // 关闭对话框
            DOM.recruitModal.style.display = "none";
            
            // 记录事件
            logEvent(`${gameData.player.name}收下了弟子${disciple.name}。`);
        }
        
        // 生成弟子数据
        function generateDisciple() {
            // 生成基础数据
            const name = getRandomName();
            
            // 随机选择一个五行属性
            const elementKeys = Object.keys(elements);
            const element = elementKeys[Math.floor(Math.random() * elementKeys.length)];
            
            // 随机确定是否有变异属性（20%几率）
            let variation = null;
            if (Math.random() < 0.2) {
                const variationKeys = Object.keys(variations);
                variation = variationKeys[Math.floor(Math.random() * variationKeys.length)];
            }
            
            // 随机生成灵根纯度
            const purity = Math.floor(Math.random() * 100) + 1;
            
            // 随机生成悟性（1-100）
            const comprehension = Math.floor(Math.random() * 100) + 1;
            
            // 随机生成气运（-50至50）
            const luck = Math.floor(Math.random() * 101) - 50;
            
            // 随机决定是否有天赋（30%几率）
            let talent = null;
            if (Math.random() < 0.3) {
                talent = talents[Math.floor(Math.random() * talents.length)];
            }
            
            // 随机决定是否有因果（10%几率）
            let fate = null;
            if (Math.random() < 0.1) {
                const enemySects = ["天火宗", "玄水派", "金光宗", "碧玉门", "玄冥教"];
                const enemySect = enemySects[Math.floor(Math.random() * enemySects.length)];
                const pressureLevel = Math.floor(Math.random() * 5) + 1;
                fate = `命定之敌：${enemySect}首席（战力压制${pressureLevel}00%）`;
            }
            
            // 创建弟子对象
            return {
                name,
                element,
                variation,
                purity,
                comprehension,
                luck,
                talent,
                fate,
                cultivation: {
                    stage: 0, // 0: 炼气, 1: 筑基, 2: 金丹, 3: 元婴, 4: 化神
                    subStage: 0, // 0: 初期, 1: 中期, 2: 后期, 3: 圆满
                    progress: 0 // 0-100
                },
                pillEffect: 0, // 丹药效果持续时间
                canBreakthrough: false, // 是否可以突破
                breaking: false, // 是否正在突破
                loyalty: 50 // 忠诚度（0-100）
            };
        }
        
        // 更新弟子列表UI
        function updateDiscipleList() {
            if (gameData.disciples.length === 0) {
                DOM.discipleList.innerHTML = '<li class="no-disciples">暂无弟子，请招收弟子</li>';
                return;
            }
            
            let html = '';
            gameData.disciples.forEach(disciple => {
                const stage = gameData.player.stageNames[disciple.cultivation.stage];
                const subStage = gameData.player.subStageNames[disciple.cultivation.subStage];
                
                html += `
                    <li class="disciple-item" data-id="${disciple.id}">
                        <div><strong>${disciple.name}</strong> - ${stage}${subStage}</div>
                        <div><span class="element-${disciple.element}">${elements[disciple.element].name}灵根</span> (${disciple.purity}%)</div>
                    </li>
                `;
            });
            
            DOM.discipleList.innerHTML = html;
            
            // 添加点击事件
            document.querySelectorAll('.disciple-item').forEach(item => {
                item.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    selectDisciple(id);
                    
                    // 移除其他选中状态
                    document.querySelectorAll('.disciple-item').forEach(i => {
                        i.classList.remove('selected');
                    });
                    
                    // 添加选中状态
                    this.classList.add('selected');
                });
            });
        }
        
        // 选择弟子
        function selectDisciple(id) {
            const disciple = gameData.disciples.find(d => d.id === id);
            if (!disciple) return;
            
            gameData.currentDisciple = disciple;
            updateDiscipleDetail();
            
            // 显示弟子详情
            DOM.discipleDetail.style.display = "block";
        }
        
        // 更新弟子详情UI
        function updateDiscipleDetail() {
            const disciple = gameData.currentDisciple;
            if (!disciple) return;
            
            const stage = gameData.player.stageNames[disciple.cultivation.stage];
            const subStage = gameData.player.subStageNames[disciple.cultivation.subStage];
            
            DOM.detailName.textContent = disciple.name;
            DOM.detailCultivation.textContent = `${stage}${subStage}`;
            DOM.detailElement.textContent = `${elements[disciple.element].name}${disciple.variation ? `（变异：${variations[disciple.variation].name}）` : ''}`;
            DOM.detailPurity.textContent = `${disciple.purity}%`;
            DOM.detailComprehension.textContent = disciple.comprehension;
            DOM.detailLuck.textContent = disciple.luck;
            
            // 更新进度条
            DOM.cultivationProgress.style.width = `${disciple.cultivation.progress}%`;
            
            // 更新按钮状态
            DOM.givePillBtn.disabled = gameData.player.resources.pills <= 0;
            DOM.collectPillBtn.disabled = disciple.cultivation.stage < 2; // 金丹期以上才能上贡丹药
            DOM.breakthroughBtn.disabled = !disciple.canBreakthrough;
            
            // 如果弟子有丹药效果，显示加速状态
            if (disciple.pillEffect > 0) {
                DOM.cultivationProgress.style.backgroundColor = "#ff5722";
            } else {
                DOM.cultivationProgress.style.backgroundColor = "#8B4513";
            }
        }
        
        // 赐予丹药
        function givePill() {
            if (!gameData.currentDisciple) return;
            
            // 检查丹药数量
            if (gameData.player.resources.pills <= 0) {
                logEvent("丹药不足，无法赐予。");
                return;
            }
            
            // 扣除丹药
            gameData.player.resources.pills -= 1;
            
            // 设置丹药传递动画
            DOM.transferPill.style.left = "10%";
            DOM.transferDirection.textContent = "掌门 → 弟子";
            
            // 启动动画
            setTimeout(() => {
                DOM.transferPill.style.left = "90%";
                
                // 动画结束后添加丹药效果
                setTimeout(() => {
                    // 添加丹药效果（持续30秒）
                    gameData.currentDisciple.pillEffect += 30;
                    
                    // 有小概率触发丹毒体质
                    if (gameData.currentDisciple.talent && gameData.currentDisciple.talent.id === "pill_poison" && Math.random() < 0.05) {
                        gameData.currentDisciple.variation = "poison";
                        logEvent(`${gameData.currentDisciple.name}服用丹药后，体内丹毒发作，转化为毒灵根！`);
                    }
                    
                    // 记录事件
                    logEvent(`掌门赐予${gameData.currentDisciple.name}一枚丹药，修炼速度大幅提升！`);
                    
                    // 更新UI
                    updateDiscipleDetail();
                }, 1000);
            }, 100);
        }
        
        // 收集丹药
        function collectPill() {
            if (!gameData.currentDisciple) return;
            
            // 只有金丹期以上的弟子才能上贡丹药
            if (gameData.currentDisciple.cultivation.stage < 2) {
                logEvent(`${gameData.currentDisciple.name}修为尚浅，无法炼制丹药。`);
                return;
            }
            
            // 设置丹药传递动画
            DOM.transferPill.style.left = "90%";
            DOM.transferDirection.textContent = "弟子 → 掌门";
            
            // 启动动画
            setTimeout(() => {
                DOM.transferPill.style.left = "10%";
                
                // 动画结束后增加丹药
                setTimeout(() => {
                    // 基础丹药产出
                    let pillGain = 1;
                    
                    // 根据弟子修为增加产出
                    pillGain += gameData.currentDisciple.cultivation.stage;
                    
                    // 如果弟子是木属性，增加产出
                    if (gameData.currentDisciple.element === "wood") {
                        pillGain = Math.floor(pillGain * 1.5);
                    }
                    
                    // 增加丹药
                    gameData.player.resources.pills += pillGain;
                    
                    // 记录事件
                    logEvent(`${gameData.currentDisciple.name}向掌门上贡了${pillGain}枚丹药。`);
                    
                    // 更新UI
                    updateUI();
                }, 1000);
            }, 100);
        }
        
        // 尝试突破
        function attemptBreakthrough() {
            if (!gameData.currentDisciple || !gameData.currentDisciple.canBreakthrough) return;
            
            const disciple = gameData.currentDisciple;
            
            // 设置突破状态
            disciple.breaking = true;
            
            // 显示突破对话框
            DOM.breakthroughModal.style.display = "flex";
            DOM.breakthroughName.textContent = disciple.name;
            DOM.breakthroughProgress.style.width = "0%";
            DOM.breakthroughResult.textContent = "";
            DOM.closeBreakthroughBtn.style.display = "none";
            
            // 突破过程动画
            let progress = 0;
            const interval = setInterval(() => {
                progress += 1;
                DOM.breakthroughProgress.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    calculateBreakthroughResult();
                }
            }, 50);
        }
        
        // 计算突破结果
        function calculateBreakthroughResult() {
            const disciple = gameData.currentDisciple;
            
            // 基础成功率
            let successRate = 50;
            
            // 根据纯度和悟性增加成功率
            successRate += disciple.purity / 5;
            successRate += Math.log10(disciple.comprehension) * 10;
            
            // 根据气运调整成功率
            successRate += disciple.luck;
            
            // 丹药效果增加成功率
            if (disciple.pillEffect > 0) {
                successRate += 20;
            }
            
            // 突破难度随境界提高
            const difficulty = 10 * (disciple.cultivation.stage + 1);
            successRate -= difficulty;
            
            // 限制成功率范围
            successRate = Math.max(5, Math.min(95, successRate));
            
            // 确定突破结果
            let success = Math.random() * 100 < successRate;
            
            // 轮回体天赋：突破失败也不会受到反噬
            let noBacklash = disciple.talent && disciple.talent.id === "reincarnation";
            
            if (success) {
                // 突破成功
                if (disciple.cultivation.subStage < 3) {
                    // 小境界提升
                    disciple.cultivation.subStage += 1;
                    
                    DOM.breakthroughResult.innerHTML = `<span style="color: green;">突破成功！</span>${disciple.name}修为提升至${gameData.player.stageNames[disciple.cultivation.stage]}${gameData.player.subStageNames[disciple.cultivation.subStage]}。`;
                    logEvent(`${disciple.name}成功突破至${gameData.player.stageNames[disciple.cultivation.stage]}${gameData.player.subStageNames[disciple.cultivation.subStage]}。`);
                } else {
                    // 大境界提升
                    disciple.cultivation.stage += 1;
                    disciple.cultivation.subStage = 0;
                    
                    // 检查是否超过玩家境界
                    if (disciple.cultivation.stage > gameData.player.stage) {
                        DOM.breakthroughResult.innerHTML = `<span style="color: orange;">突破受阻！</span>${disciple.name}即将突破至${gameData.player.stageNames[disciple.cultivation.stage]}，但由于掌门修为不足，无法引导，突破失败。`;
                        logEvent(`${disciple.name}尝试突破至${gameData.player.stageNames[disciple.cultivation.stage]}，但由于掌门修为不足，突破失败。`);
                        
                        // 境界倒退
                        disciple.cultivation.subStage = 3;
                        disciple.cultivation.stage -= 1;
                    } else {
                        DOM.breakthroughResult.innerHTML = `<span style="color: green; font-weight: bold;">大境界突破成功！</span>${disciple.name}修为跃升至${gameData.player.stageNames[disciple.cultivation.stage]}${gameData.player.subStageNames[disciple.cultivation.subStage]}！`;
                        logEvent(`${disciple.name}成功突破至${gameData.player.stageNames[disciple.cultivation.stage]}${gameData.player.subStageNames[disciple.cultivation.subStage]}！`);
                        
                        // 宗门威望增加
                        gameData.sect.prestige += 10 * (disciple.cultivation.stage + 1);
                    }
                }
            } else {
                // 突破失败
                if (noBacklash) {
                    DOM.breakthroughResult.innerHTML = `<span style="color: orange;">突破失败！</span>但由于${disciple.name}拥有九转轮回体，没有受到反噬，并有所感悟。`;
                    logEvent(`${disciple.name}突破失败，但由于特殊体质没有受到反噬。`);
                    
                    // 增加少量修为
                    disciple.cultivation.progress = 20;
                } else {
                    DOM.breakthroughResult.innerHTML = `<span style="color: red;">突破失败！</span>${disciple.name}遭受反噬，修为倒退。`;
                    logEvent(`${disciple.name}突破失败，修为受损。`);
                    
                    // 修为倒退
                    disciple.cultivation.progress = 0;
                    if (Math.random() < 0.3) {
                        if (disciple.cultivation.subStage > 0) {
                            disciple.cultivation.subStage -= 1;
                        }
                    }
                }
            }
            
            // 重置突破状态
            disciple.breaking = false;
            disciple.canBreakthrough = false;
            disciple.cultivation.progress = Math.min(disciple.cultivation.progress, 99);
            
            // 显示关闭按钮
            DOM.closeBreakthroughBtn.style.display = "block";
            
            // 更新弟子列表和详情
            updateDiscipleList();
            updateDiscipleDetail();
        }
        
        // 关闭突破对话框
        function closeBreakthroughModal() {
            DOM.breakthroughModal.style.display = "none";
        }
        
        // 宗门升级
        function upgradeSect() {
            // 计算升级所需灵石
            const upgradeCost = gameData.sect.level * 500;
            
            // 检查灵石是否足够
            if (gameData.player.resources.spiritStones < upgradeCost) {
                logEvent(`灵石不足，无法升级宗门。需要${upgradeCost}灵石。`);
                return;
            }
            
            // 扣除灵石
            gameData.player.resources.spiritStones -= upgradeCost;
            
            // 升级宗门
            gameData.sect.level += 1;
            
            // 增加弟子上限
            gameData.sect.maxDisciples += 2;
            
            // 记录事件
            logEvent(`${gameData.player.sect}成功升级至${gameData.sect.level}级！可容纳弟子上限增加至${gameData.sect.maxDisciples}人。`);
            
            // 更新UI
            updateUI();
        }
        
        // 开始战斗
        function startBattle() {
            // 切换到战斗界面
            DOM.mainScreen.style.display = "none";
            DOM.battleScreen.style.display = "flex";
            
            // 初始化战斗数据
            initBattle();
        }
        
        // 初始化战斗
        function initBattle() {
            // 待实现：完整的战斗系统
            logBattleEvent("战斗模式初始化...");
            logBattleEvent("敌对宗门向我宗发起挑战！");
        }
        
        // 执行攻击
        function performAttack() {
            logBattleEvent("执行了普通攻击，造成100点伤害。");
        }
        
        // 使用技能
        function useSkill() {
            logBattleEvent("使用了五行剑诀，造成150点伤害。");
        }
        
        // 启动阵法
        function activateFormation() {
            logBattleEvent("启动了朱雀焚天阵，每10秒对敌方造成范围伤害。");
        }
        
        // 结束战斗
        function endBattle() {
            // 切换回主界面
            DOM.battleScreen.style.display = "none";
            DOM.mainScreen.style.display = "flex";
            
            // 记录战斗结果
            logEvent("宗门对战结束，我方获胜！获得100灵石和10点威望。");
            
            // 增加资源
            gameData.player.resources.spiritStones += 100;
            gameData.sect.prestige += 10;
            
            // 更新UI
            updateUI();
        }
        
        // 记录战斗日志
        function logBattleEvent(message) {
            const logEntry = document.createElement("div");
            logEntry.className = "log-entry";
            logEntry.textContent = message;
            DOM.battleLogs.appendChild(logEntry);
            
            // 自动滚动到底部
            DOM.battleLogs.scrollTop = DOM.battleLogs.scrollHeight;
        }
        
        // 记录事件日志
        function logEvent(message) {
            const logEntry = document.createElement("div");
            logEntry.className = "log-entry fade-in";
            logEntry.textContent = message;
            
            // 事件记录太多时，保留最新的20条
            if (DOM.eventsLog.childElementCount >= 20) {
                DOM.eventsLog.removeChild(DOM.eventsLog.firstChild);
            }
            
            DOM.eventsLog.appendChild(logEntry);
            
            // 自动滚动到底部
            DOM.eventsLog.scrollTop = DOM.eventsLog.scrollHeight;
            
            // 记录到游戏数据中
            gameData.events.push({
                message,
                time: Date.now()
            });
        }
        
        // 辅助函数：获取随机宗门名称
        function getRandomSectName() {
            const prefix = ["青云", "逍遥", "天一", "蜀山", "昆仑", "蓬莱", "玄天", "太虚", "紫霄", "星辰", "灵霄", "九天", "五岳", "万剑", "碧落"];
            const suffix = ["门", "宗", "派", "阁", "观", "山", "殿", "楼", "苑", "峰", "洞天", "福地"];
            
            return prefix[Math.floor(Math.random() * prefix.length)] + suffix[Math.floor(Math.random() * suffix.length)];
        }
        
        // 获取随机道号
        function getRandomName() {
            if (Math.random() < 0.3) {
                // 单字道号
                return names1[Math.floor(Math.random() * names1.length)];
            } else {
                // 双字道号
                return names1[Math.floor(Math.random() * names1.length)] + names2[Math.floor(Math.random() * names2.length)];
            }
        }
        
        // 生成随机ID
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }
        
        // 初始化游戏
        document.addEventListener("DOMContentLoaded", initGame);
    </script>
</body>
</html>